@{
    ViewBag.Title = "Reports";
}

<div class="container-fluid">
    <h1 class="text-center mb-4">
        <i class="fas fa-chart-line"></i> Business Reports & Analytics
    </h1>

    <div class="card mb-4 shadow">
        <div class="card-header bg-primary text-white">
            <h3><i class="fas fa-file-alt"></i> Generate Report</h3>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Select Report Type:</label>
                    <select class="form-select" id="reportType" onchange="generateReport()">
                        <option value="">-- Choose a Report --</option>
                        <option value="sales">Current Sales Report</option>
                        <option value="popular">Popular Products Report</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div id="reportDisplayArea" style="display: none;">
        <div id="salesReportSection" style="display: none;">
            <div class="card mb-4 shadow">
                <div class="card-header bg-info text-white">
                    <h4><i class="fas fa-shopping-cart"></i> Current Sales Report</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="salesChart" style="max-height: 400px;"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>Report Summary</h5>
                                    <hr>
                                    <p><strong>Total Orders:</strong> <span id="totalOrders">0</span></p>
                                    <p><strong>Total Revenue:</strong> $<span id="totalRevenue">0</span></p>
                                    <p><strong>Generated:</strong> <span id="reportDate"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h5>Detailed Sales Data</h5>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Staff</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Discount</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="popularReportSection" style="display: none;">
            <div class="card mb-4 shadow">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-star"></i> Popular Products Report</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="popularChart" style="max-height: 400px;"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>Top Product</h5>
                                    <hr>
                                    <p><strong>Product:</strong> <span id="topProduct">-</span></p>
                                    <p><strong>Total Sold:</strong> <span id="topProductQty">0</span></p>
                                    <p><strong>Brand:</strong> <span id="topProductBrand">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h5>Product Rankings</h5>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Rank</th>
                                    <th>Product</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Total Orders</th>
                                    <th>Total Quantity Sold</th>
                                </tr>
                            </thead>
                            <tbody id="popularTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow">
            <div class="card-header bg-warning">
                <h4><i class="fas fa-save"></i> Save Report</h4>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">File Name:</label>
                        <input type="text" class="form-control" id="fileName" placeholder="Enter filename">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">File Type:</label>
                        <select class="form-select" id="fileType">
                            <option value="pdf">PDF (.pdf)</option>
                            <option value="xlsx">Excel (.xlsx)</option>
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-end">
                        <button class="btn btn-success me-2" onclick="saveReport()">
                            <i class="fas fa-download"></i> Save Report
                        </button>
                        <button class="btn btn-info" data-bs-toggle="collapse" data-bs-target="#descriptionSection">
                            <i class="fas fa-comment"></i> Add Description (Bonus)
                        </button>
                    </div>
                </div>

                <div class="collapse mt-3" id="descriptionSection">
                    <label class="form-label fw-bold">Report Description:</label>
                    <textarea id="reportDescription" class="form-control" rows="4" placeholder="Enter a detailed description of this report..."></textarea>
                    <small class="text-muted">This rich text description will be saved with your report for future reference.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow">
        <div class="card-header bg-dark text-white">
            <h3><i class="fas fa-archive"></i> Document Archive</h3>
        </div>
        <div class="card-body">
            <button class="btn btn-primary mb-3" onclick="loadArchivedReports()">
                <i class="fas fa-sync"></i> Refresh Archive
            </button>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>File Name</th>
                            <th>File Size</th>
                            <th>Created Date</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="archiveTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <em>No archived reports. Generate and save a report to see it here.</em>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editDescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Report Description</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editDescFileName">
                <label class="form-label fw-bold">Description:</label>
                <textarea id="editDescriptionText" class="form-control" rows="6"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateDescription()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
    <script>
        let currentChartSales = null;
        let currentChartPopular = null;
        let currentReportType = '';
        let currentReportData = null;

tinymce.init({
    selector: '#reportDescription',
    height: 200,
    menubar: false,
    plugins: 'lists link',
    toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist',
    promotion: false
});

tinymce.init({
    selector: '#editDescriptionText',
    height: 250,
    menubar: false,
    plugins: 'lists link',
    toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist',
    promotion: false
});

        $(document).ready(function () {
            loadArchivedReports();
        });

        function generateReport() {
            const reportType = $('#reportType').val();
            if (!reportType) {
                $('#reportDisplayArea').hide();
                return;
            }

            currentReportType = reportType;
            $('#reportDisplayArea').show();
            $('#salesReportSection').hide();
            $('#popularReportSection').hide();

            if (reportType === 'sales') {
                loadSalesReport();
            } else if (reportType === 'popular') {
                loadPopularProductsReport();
            }
        }

        function loadSalesReport() {
            $.ajax({
                url: '@Url.Action("GetSalesReportData", "Report")',
                type: 'GET',
                success: function (data) {
                    currentReportData = data;
                    $('#salesReportSection').show();
                    displaySalesData(data);
                    createSalesChart(data);

                    $('#totalOrders').text(data.length);
                    const totalRev = data.reduce((sum, item) => sum + item.Total, 0);
                    $('#totalRevenue').text(totalRev.toFixed(2));
                    $('#reportDate').text(new Date().toLocaleString());
                }
            });
        }

        function displaySalesData(data) {
            const tbody = $('#salesTableBody');
            tbody.empty();

            data.forEach(item => {
                tbody.append(`
                    <tr>
                        <td>${item.OrderId}</td>
                        <td>${new Date(item.OrderDate).toLocaleDateString()}</td>
                        <td>${item.CustomerName}</td>
                        <td>${item.ProductName}</td>
                        <td>${item.StaffName}</td>
                        <td>${item.Quantity}</td>
                        <td>$${item.Price.toFixed(2)}</td>
                        <td>${(item.Discount * 100).toFixed(0)}%</td>
                        <td>$${item.Total.toFixed(2)}</td>
                    </tr>
                `);
            });
        }

        function createSalesChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                const month = new Date(item.OrderDate).toLocaleString('default', { month: 'short', year: 'numeric' });
                if (!monthlyData[month]) {
                    monthlyData[month] = 0;
                }
                monthlyData[month] += item.Total;
            });

            const labels = Object.keys(monthlyData);
            const values = Object.values(monthlyData);

            if (currentChartSales) {
                currentChartSales.destroy();
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            currentChartSales = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Sales Revenue ($)',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Sales Revenue by Month',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadPopularProductsReport() {
            $.ajax({
                url: '@Url.Action("GetPopularProductsData", "Report")',
                type: 'GET',
                success: function (data) {
                    currentReportData = data;
                    $('#popularReportSection').show();
                    displayPopularData(data);
                    createPopularChart(data);

                    if (data.length > 0) {
                        $('#topProduct').text(data[0].ProductName);
                        $('#topProductQty').text(data[0].TotalQuantity);
                        $('#topProductBrand').text(data[0].Brand);
                    }
                }
            });
        }

        function displayPopularData(data) {
            const tbody = $('#popularTableBody');
            tbody.empty();

            data.forEach((item, index) => {
                tbody.append(`
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td>${item.ProductName}</td>
                        <td><span class="badge bg-primary">${item.Brand}</span></td>
                        <td><span class="badge bg-secondary">${item.Category}</span></td>
                        <td>${item.TotalOrders}</td>
                        <td><strong>${item.TotalQuantity}</strong></td>
                    </tr>
                `);
            });
        }

        function createPopularChart(data) {
            const labels = data.map(item => item.ProductName.substring(0, 20) + '...');
            const values = data.map(item => item.TotalQuantity);

            if (currentChartPopular) {
                currentChartPopular.destroy();
            }

            const ctx = document.getElementById('popularChart').getContext('2d');
            currentChartPopular = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantity Sold',
                        data: values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)',
                            'rgba(83, 102, 255, 0.7)',
                            'rgba(255, 99, 255, 0.7)',
                            'rgba(99, 255, 132, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Top 10 Most Popular Products',
                            font: { size: 16 }
                        }
                    }
                }
            });
        }

        function saveReport() {
            const fileName = $('#fileName').val();
            const fileType = $('#fileType').val();
            const description = tinymce.get('reportDescription').getContent();

            if (!fileName) {
                alert('Please enter a filename.');
                return;
            }

            if (!currentReportType) {
                alert('Please generate a report first.');
                return;
            }

            $.ajax({
                url: '@Url.Action("SaveReport", "Report")',
                type: 'POST',
                data: {
                    fileName: fileName,
                    fileType: fileType,
                    reportType: currentReportType,
                    description: description
                },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        $('#fileName').val('');
                        tinymce.get('reportDescription').setContent('');
                        loadArchivedReports();
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Error saving report.');
                }
            });
        }

        function loadArchivedReports() {
            $.ajax({
                url: '@Url.Action("GetArchivedReports", "Report")',
                type: 'GET',
                success: function (data) {
                    const tbody = $('#archiveTableBody');
                    tbody.empty();

                    if (data.length === 0) {
                        tbody.append(`
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <em>No archived reports found.</em>
                                </td>
                            </tr>
                        `);
                        return;
                    }

                    data.forEach(report => {
                        const descPreview = report.description ?
                            (report.description.substring(0, 50) + '...') :
                            '<em class="text-muted">No description</em>';

                        tbody.append(`
                            <tr>
                                <td><i class="fas fa-file"></i> ${report.fileName}</td>
                                <td>${report.fileSize}</td>
                                <td>${report.createdDate}</td>
                                <td>${descPreview}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editDescription('${report.fileName}', \`${report.description}\`)">
                                        <i class="fas fa-edit"></i> Edit Desc
                                    </button>
                                    <a href="@Url.Action("DownloadReport", "Report")?fileName=${report.fileName}"
                                       class="btn btn-sm btn-success">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.fileName}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                }
            });
        }

        function editDescription(fileName, currentDesc) {
            $('#editDescFileName').val(fileName);
            tinymce.get('editDescriptionText').setContent(currentDesc || '');
            $('#editDescriptionModal').modal('show');
        }

        function updateDescription() {
            const fileName = $('#editDescFileName').val();
            const description = tinymce.get('editDescriptionText').getContent();

            $.ajax({
                url: '@Url.Action("UpdateReportDescription", "Report")',
                type: 'POST',
                data: {
                    fileName: fileName,
                    description: description
                },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        $('#editDescriptionModal').modal('hide');
                        loadArchivedReports();
                    } else {
                        alert(response.message);
                    }
                }
            });
        }

        function deleteReport(fileName) {
            if (confirm('Are you sure you want to delete this report?')) {
                $.ajax({
                    url: '@Url.Action("DeleteReport", "Report")',
                    type: 'POST',
                    data: { fileName: fileName },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            loadArchivedReports();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            }
        }
    </script>
}